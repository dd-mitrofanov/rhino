# VPN Bot

Telegram-бот для управления ключами доступа к VPN-серверам. Взаимодействует с [VPN Server API](../vpn-server-api) по HTTP. Данные хранятся в SQLite.

## Роли

- **Администратор** — управление серверами, создание инвайтов, просмотр и отзыв любых ключей, список пользователей.
- **Пользователь** — приглашение гостей, генерация ключей (до 2 на сервер), отзыв своих ключей.
- **Гость** — генерация ключей (до 2 на сервер), отзыв своих ключей.

## Требования

- Node.js 18+
- Токен бота от [@BotFather](https://t.me/BotFather)

## Установка

```bash
npm install
cp .env.example .env
# Заполните BOT_TOKEN в .env
```

## Первый администратор

Первый пользователь с ролью `admin` создаётся вручную. После первого запуска бота создаётся БД `data/bot.db`. Добавьте администратора так:

```bash
sqlite3 data/bot.db "INSERT INTO users (id, role) VALUES (ВАШ_TELEGRAM_ID, 'admin');"
```

Узнать свой Telegram ID можно у [@userinfobot](https://t.me/userinfobot).

## Запуск

```bash
npm start
```

Или с автоперезагрузкой при разработке:

```bash
npm run dev
```

## Переменные окружения

| Переменная        | Описание                    | По умолчанию   |
|-------------------|----------------------------|----------------|
| BOT_TOKEN         | Токен бота                 | —              |
| DATABASE_PATH     | Путь к файлу SQLite        | ./data/bot.db  |

## Команды бота

### Общие (все зарегистрированные)

- `/start` — приветствие и меню по роли
- `/activate <код>` — активация инвайт-кода (для новых пользователей)
- `/my_keys` — мои ключи
- `/generate_key` — создать ключ (выбор сервера, лимит 2 ключа на сервер)
- `/revoke_key` — отозвать свой ключ (у админа — выбор пользователя и ключа)

### Пользователь

- `/invite_guest` — создать одноразовый инвайт для гостя

### Администратор

- `/add_server` — пошаговое добавление сервера (имя, IP, порт, API-токен, API-URL)
- `/delete_server` — удалить сервер (с подтверждением, ключи каскадно удаляются)
- `/list_servers` — список серверов
- `/create_invite` — создать инвайт (выбор роли: user/guest)
- `/keys_of` — ключи пользователя (ввод ID или выбор из списка)
- `/list_users` — список пользователей с ролями и количеством ключей

## API сервера

Бот использует эндпоинты VPN Server API:

- `POST /generate-key` — тело `{ "userId": "<telegram_id>" }`, заголовок `Authorization: Bearer <api_token>`
- `DELETE /reject-key/:keyId` — отзыв ключа

При добавлении сервера через `/add_server` указывается API-URL (например `http://1.2.3.4:3000`) и токен из переменной `TOKEN` приложения на сервере.

## Graceful shutdown

При получении SIGTERM или SIGINT бот останавливает приём обновлений и закрывает соединение с БД.
